{% extends 'bedesk/base.html' %}

{% block title %}Horários - {{ sala.nome }}{% endblock %} 

{% block content %}
<div class="container-fluid mt-4">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        
        <a href="{% url 'detalhe_sala' nome_sala=sala.nome %}?foco={{ semana_anterior }}" 
           class="btn btn-outline-secondary {% if disable_semana_anterior %}disabled{% endif %}"
           {% if disable_semana_anterior %}aria-disabled="true" title="Limite de histórico: Somente a semana anterior é visível"{% endif %}>
            <i class="fa-solid fa-chevron-left"></i> Semana Anterior
        </a>

        <a href="{% url 'detalhe_sala' nome_sala=sala.nome %}?foco={{ proxima_semana }}" 
           class="btn btn-outline-primary {% if disable_proxima_semana %}disabled{% endif %}"
           {% if disable_proxima_semana %}aria-disabled="true" title="Limite de futuro: Apenas a próxima semana é visível"{% endif %}>
            Próxima Semana <i class="fa-solid fa-chevron-right"></i>
        </a>
    </div>
    <h2 class="text-center mb-1">Horários da Sala {{ sala.nome }}</h2>
    
    <h4 class="text-center text-muted mb-4">
        Semana de {{ faixa_datas_semana.inicio }} a {{ faixa_datas_semana.fim }}
        {% if status_semana == 'PASSADA' %}
            <span class="badge bg-danger ms-2">HISTÓRICO</span>
        {% endif %}
    </h4>
    <div class="table-responsive">
        <table class="table table-bordered table-hover shadow-sm text-center">
            
            <thead class="table-dark">
                <tr>
                    <th style="width: 12%;">Horário</th>
                    
                    {% for dia in dias_com_data %}
                        <th style="width: 17.6%;">
                            {{ dia.nome_dia }} <br> 
                            <small class="text-light opacity-75 fw-normal">{{ dia.data_formatada }}</small>
                        </th>
                    {% endfor %}
                </tr>
            </thead>

            <tbody>
                {% for linha in tabela_horarios %}
                    
                    {% comment %} TIPO 1: Linha Separadora (Manhã/Tarde) {% endcomment %}
                    {% if linha.tipo == 'separador' %}
                        <tr class="table-light">
                            <td colspan="6" class="text-center fw-bold fs-5">
                                {{ linha.nome }}
                            </td>
                        </tr>

                    {% comment %} TIPO 2: Linha de Intervalo {% endcomment %}
                    {% elif linha.tipo == 'intervalo' %}
                        <tr class="table-secondary text-muted">
                            <td class="align-middle">
                                {{ linha.inicio }} às {{ linha.fim }}
                            </td>
                            <td colspan="5" class="align-middle fst-italic">
                                {{ linha.nome }}
                            </td>
                        </tr>

                    {% comment %} TIPO 3: Linha de Horário Normal {% endcomment %}
                    {% elif linha.tipo == 'hora' %}
                        <tr>
                            <td class="align-middle fw-bold">
                                {{ linha.horario_str }}
                            </td>
                            
                            {% for celula in linha.celulas %}
                                <td class="align-middle">
                                    
                                    {% if celula.agendamento %}
                                        <div class="d-flex flex-column justify-content-center align-items-center h-100">
                                            
                                            <span class="fw-bold text-uppercase" 
                                                  style="font-size: 0.9em; {% if celula.agendamento.status == 'PENDENTE' %}color:#b45309;{% else %}color:#b91c1c;{% endif %}" 
                                                  data-bs-toggle="tooltip" 
                                                  title="Motivo: {{ celula.agendamento.motivo }}">
                                                {{ celula.agendamento.nome }}
                                            </span>
                                            {% if celula.agendamento.status == 'PENDENTE' %}
                                                <span class="badge bg-warning text-dark mt-1">Pendente</span>
                                            {% else %}
                                                <span class="badge bg-success mt-1">Aprovado</span>
                                            {% endif %}
                                            
                                            <small class="text-muted fw-bold" style="font-size: 0.8em;">
                                                ({{ celula.agendamento.usuario.first_name|default:celula.agendamento.usuario.username }})
                                            </small>

                                        </div>

                                    {% else %}
                                        {% if status_semana == 'PASSADA' %}
                                            <button class="btn btn-secondary btn-sm w-100" disabled>
                                                <i class="fa-solid fa-lock fa-lg"></i>
                                            </button>
                                            <small class="text-muted" style="font-size: 0.75em;">Semana Encerrada</small>
                                        
                                        {% else %}
                                            <a href="{% url 'agendar_sala' %}?hora={{ linha.hora_para_link }}&data={{ celula.data|date:'Y-m-d' }}&sala={{ sala.nome }}" 
                                               class="btn btn-primary btn-sm w-100"
                                               data-bs-toggle="tooltip" 
                                               title="Clique para agendar">
                                                
                                                <i class="fa-solid fa-plus fa-lg"></i>
                                                
                                            </a>
                                        {% endif %}

                                    {% endif %}

                                </td>
                            {% endfor %}
                        </tr>
                    {% endif %}

                {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            Nenhum horário definido na estrutura da view.
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div> 
</div>

{% endblock %}
